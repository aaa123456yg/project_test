<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分析結果</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
        .container { max-width: 800px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .results-box { margin-bottom: 20px; background: #eee; padding: 15px; border-radius: 4px; }
        .results-box h3 { margin-top: 0; }
        .plot-image { width: 100%; height: auto; border: 1px solid #ccc; margin-top: 15px; }
        .error { color: red; font-weight: bold; }
        
        .playlist-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .playlist-card { display: flex; align-items: center; border: 1px solid #ddd; background: #fdfdfd; border-radius: 5px; overflow: hidden; }
        .playlist-card img { width: 150px; height: 120px; object-fit: cover; flex-shrink: 0; }
        .playlist-card .info { padding: 15px; }
        .playlist-card h4 { margin: 0 0 5px 0; color: #0056b3; }
        .playlist-card p { margin: 0; font-size: 0.9em; }

        .action-button { display: inline-block; padding: 12px 20px; font-size: 16px; font-weight: bold; color: white; text-decoration: none; border-radius: 5px; text-align: center; }
        .back-link { background: #6c757d; margin-right: 10px; }
        .back-link:hover { background: #5a6268; }
        .generate-button { background: #28a745; }
        .generate-button:hover { background: #218838; }
        
        /* --- *** 變動：合成中提示 (樣式更新) *** --- */
        #generating-overlay {
            display: none; /* 預設隱藏 */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            z-index: 1000;
            
            /* 改為 Flexbox 置中 */
            display: none; 
            flex-direction: column; /* 讓文字在進度條上方 */
            justify-content: center;
            align-items: center;
        }
        #generating-overlay p {
            font-size: 1.5em;
            text-align: center;
            margin-bottom: 20px; /* 與進度條間距 */
        }

        /* --- *** 新增：動畫進度條 (從 index.html 複製過來) *** --- */
        .progress-bar {
            width: 80%; /* 進度條寬度 */
            max-width: 500px;
            height: 20px;
            background-color: #555; /* 深色背景 */
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        .progress-bar-inner {
            width: 100%;
            height: 100%;
            background-color: #007BFF; /* 藍色 */
            position: absolute;
            left: -100%;
            animation: move-progress 2s linear infinite;
        }
        
        /* CSS 動畫 */
        @keyframes move-progress {
            0% { left: -100%; }
            100% { left: 100%; }
        }

    </style>
</head>
<body>
    <div id="generating-overlay">
        <p>
            ⏳ 影片合成中，請稍候... <br>
            (這可能需要數分鐘，請勿關閉此頁面)
        </p>
        <div class="progress-bar">
            <div class="progress-bar-inner"></div>
        </div>
    </div>


    <div class="container">
        <h2>分析結果</h2>
        
        <div class="results-box">
            <p><strong>上傳檔案:</strong> {{ filename }}</p>
            <p><strong>選擇難度:</strong> {{ difficulty }}</p>
        </div>

        {% if analysis_results and analysis_results.success %}
            
            <div class="results-box">
                <h3>音樂分段 (秒)</h3>
                <ul>
                    {% for segment in analysis_results.segments %}
                        <li>
                            <b>{{ segment.label }}</b>: 
                            {{ "%.2f"|format(segment.start) }}s - {{ "%.2f"|format(segment.end) }}s
                        </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="results-box">
                <h3>視覺化圖譜</h3>
                {% if plot_url %}
                    <img src="{{ url_for('static', filename=plot_url) }}" alt="音樂分析圖" class="plot-image">
                {% else %}
                    <p class="error">繪製圖表時發生錯誤。</p>
                {% endif %}
            </div>

            <div class="results-box">
                <h3>配對動作清單 (隨機預覽)</h3>
                {% if matched_playlist_results and matched_playlist_results.success %}
                    <div class="playlist-grid">
                        {% for item in matched_playlist_results.playlist %}
                        <div class="playlist-card">
                            <img src="{{ item.exercise.gif_url }}" alt="{{ item.exercise.name }}">
                            <div class="info">
                                <h4>{{ item.segment_label }} ({{ "%.2f"|format(item.duration) }}s)</h4>
                                <p><strong>配對動作:</strong> {{ item.exercise.name }}</p>
                                <p><strong>難度:</strong> {{ difficulty }}</g>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="error">
                        配對動作時發生錯誤: 
                        {{ matched_playlist_results.error if matched_playlist_results else '未知錯誤' }}
                    </p>
                {% endif %}
            </div>

            <div>
                <a href="/" class="action-button back-link">返回上傳頁面</a>
                <a href="{{ url_for('generate_video', filename=filename, difficulty=difficulty) }}" 
                   class="action-button generate-button"
                   id="generate-btn">
                   ► 開始合成影片 (可能需時數分鐘)
                </a>
            </div>

        {% else %}
            <a href="/" class="action-button back-link">返回上傳頁面</a>
        {% endif %}
    </div>

    <script>
        document.getElementById('generate-btn').addEventListener('click', function() {
            // 顯示全螢幕的載入提示 (使用 'flex' 來置中)
            document.getElementById('generating-overlay').style.display = 'flex';
        });
    </script>

</body>
</html>